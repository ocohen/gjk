<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="math.js"></script>
<script type="text/javascript" src="poly.js"></script>
<script type="text/javascript" src="renderer.js"></script>
<title>GJK</title>
</head>
<body>
<canvas id="canvas" width="600px" height="400px" /> 
<script type="text/javascript">

function GetMaxDirectional(A, v)
{

    var pA;
    var max = -9999999;

    for(var i=0; i<A.verticesGlobal.length; i++)
    {
        var dot = A.verticesGlobal[i].Dot(v);
        if(dot > max)
        {
            max = dot;
            pA = A.verticesGlobal[i];
        }
    }

    return pA;
}


function Mapping(A,B, v)
{
    //alert("v=" + v.x + "," + v.y);
    var pA = GetMaxDirectional(A,v)
    var pB = GetMaxDirectional(B, v.Scale(-1) );
    //alert("pA=" + pA.x + "," + pA.y + "\npB=" + pB.x + "," + pB.y);

    return pA.Minus(pB);
}

function DetectCollision(A,B)
{
    if(A.vertices.length < 2 || B.vertices.length < 2)
    {
        return false;
    }

    var origin = Point2(0,0);
    var z = new Vector3(0,0,1);
    var a = A.verticesGlobal[0].Minus(B.verticesGlobal[0]);
    var b = Point2(0,0);
    var c = Point2(0,0);
    var v = Point2(0,0);
    var n = 0;

    while(true)
    {
        //alert("n=" + n + "\na=" + a.x + "," + a.y + "\nb=" + b.x + "," + b.y + "\nc=" + c.x + "," + c.y + "\nv=" + v.x + "," + v.y);
        switch(n)
        {
            case 0:
            {
                v = origin.Minus(a);
                b = a;
                a = Mapping(A, B, v);
                if(a.Dot(v) < 0)
                {
                    return false;
                }

                n = 1;
                break;
            }
            case 1:
            {
                var a0 = origin.Minus(a);
                var ab = b.Minus(a);
                var dot = ab.Dot(a0);
                if(dot > 0)
                {
                    v =  ab.Cross(z);
                    if(v.Dot(a0) < 0)
                    {
                        v = z.Cross(ab);
                    }

                    c = b;
                    b = a;
                    a = Mapping(A,B, v);
                    n = 2;

                    if(a.Dot(v) < 0)
                    {
                        return false;
                    }
                }else
                {
                    n = 0;
                }

                break;
            }
            case 2:
            {
                var a0 = origin.Minus(a);
                var ac = c.Minus(a);
                var ab = b.Minus(a);

                //need to find handedness of triangle
                var side = 1;
                if(ac.Cross(ab).Dot(z) < 0)
                {
                    side = -1;
                }

                if(a0.Cross(ac).Dot(z) * side > 0)
                {
                    if(a0.Dot(ac) > 0)
                    {
                        v = ac.Cross(z.Scale(side));
                        b = c;
                        n = 1;
                    }else
                    {
                        n = 0;
                    }
                }else if(ab.Cross(a0).Dot(z) * side > 0)
                {
                    if(a0.Dot(ab) > 0)
                    {
                        v = z.Scale(side).Cross(ab);
                        n = 1;
                    }else
                    {
                        n = 0;
                    }
                }else
                {
                    return true;
                }
                
                break;
            }
        }
    }

    return false;
}

var renderer;
var shapes = [];
var mouseX = 0;
var mouseY = 0;
var mouseDown = false;
var mousePress = false;

function init()
{
    var canvas = document.getElementById("canvas");
    canvas.addEventListener('mousemove',  function onMouseMove(e)
        {
        var rect = canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
        }, false);
    canvas.addEventListener('mousedown', function onMouseDown(){ mouseDown = true; mousePress = true;}, false);
    canvas.addEventListener('mouseup', function onMouseDown(){ mouseDown = false;}, false);


    var vs = [];
    var vs2 = [];
    var vs3 = [];
    vs.push( Point2(0,0) );
    vs.push( Point2(100,0) );
    vs.push( Point2(100,100) );
    vs.push( Point2(0,100) );

    vs2.push(vs[0]);
    vs2.push(vs[1]);
    vs2.push(vs[2]);

    vs3.push( Point2(50,0) );
    vs3.push( Point2(100,0) );
    vs3.push( Point2(150,50) );
    vs3.push( Point2(100,100) );
    vs3.push( Point2(50, 100) );
    vs3.push( Point2(0, 50) );
    
    var p1 = new Poly(vs, MakeTransform(200,0,0) );
    var p2 = new Poly(vs2, MakeTransform(240,110,0) );
    var p3 = new Poly(vs3, MakeTransform(150,130,0) );
    var p4 = new Poly(vs, MakeTransform(100,200,30*3.14159/180) );
    renderer = new Renderer(canvas);

    renderer.AddShape(p1);
    renderer.AddShape(p2);
    renderer.AddShape(p3);
    renderer.AddShape(p4);
    shapes.push(p1);
    shapes.push(p2);
    shapes.push(p3);
    shapes.push(p4);

    renderer.Update();
    var collisions = 0;
    for(var i=0; i<shapes.length; i++)
    {
        for(var j=i+1; j<shapes.length; j++)
        {
           var collision = DetectCollision(shapes[i], shapes[j]);
           if(collision) collisions += 1;
        }
    }
//    alert(collisions);
    setInterval(tick, 1000.0/60);
}

var currentShape = false;
var xOffset = 0;
var yOffset = 0;

function MoveShapes()
{
    if(mousePress)
    {
        mousePress = false;
        for(var i=0; i<shapes.length; i++)
        {
            if(shapes[i].ContainsPoint(Point2(mouseX,mouseY)))
            {
                currentShape = shapes[i];
                xOffset = currentShape.GetOrigin().x - mouseX;
                yOffset = currentShape.GetOrigin().y - mouseY;
                break;
            }
        }
    }

    if(currentShape)
    {
        if(mouseDown)
        {
            currentShape.SetOrigin( Point2(mouseX + xOffset, mouseY + yOffset) );
            currentShape.selected = true;
        }else
        {
            currentShape.selected = false;
            currentShape = false;
        }
    }
}

function tick()
{
    MoveShapes();

    renderer.Update();

    for(var i=0; i<shapes.length; i++)
    {
        shapes[i].collide = false;
    }
    var collisions = 0;
    for(var i=0; i<shapes.length; i++)
    {
        for(var j=i+1; j<shapes.length; j++)
        {
           var collision = DetectCollision(shapes[i], shapes[j]);
           if(collision)
           {
               collisions += 1;
               shapes[j].collide = true;
               shapes[i].collide = true;
           }
        }
    }
    var context = canvas.getContext("2d");
    context.fillStyle = "white";
    context.font = "14px Arial";
    context.fillText("Collisions: " + collisions, 10, 20);
    context.font = "12px Arial";
    context.fillText("Click and drag to move shapes", 10, 40);
}

init();
</script>


</body>
</html>
